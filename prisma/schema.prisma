generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  TEACHER
  CURATOR
  PSYCHOLOGIST
  PARENT
  STUDENT
}

enum ActivityType {
  LEISURE_GROUP
  INDIVIDUAL_LESSON
  GROUP_LESSON
  OFFSITE_EVENT
  PEDAGOGICAL_CONSILIUM
  TEACHERS_GENERAL_MEETING
  PSYCHOLOGIST_SESSION
}

enum EventStatus {
  PLANNED
  COMPLETED
  CANCELED
}

enum ParticipantRole {
  STUDENT
  TEACHER
  CURATOR
  PSYCHOLOGIST
  PARENT
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
}

enum TaskStatus {
  PENDING
  DONE
  DISMISSED
}

model User {
  id          String      @id @default(cuid())
  email       String?     @unique
  passwordHash String?
  fullName    String
  phone       String?
  role        UserRole
  googleId    String?     @unique
  isActive    Boolean     @default(true)
  timezone    String      @default("Europe/Moscow")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  teacherProfile TeacherProfile?
  studentProfile StudentProfile?
  parentProfile  ParentProfile?

  eventParticipants EventParticipant[]
  createdEvents      Event[]            @relation("EventCreatedBy")
  sessions           UserSession[]
  confirmationTasks  EventConfirmationTask[]
}

model TeacherProfile {
  id              String  @id @default(cuid())
  userId          String  @unique
  subjects        String[]
  canBeCurator    Boolean @default(false)
  paymentScheme   String?
  hourlyRateCents Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user  User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  rates TeacherRate[]
  studentLinks TeacherStudentLink[]
  curatedStudents StudentProfile[] @relation("StudentCurator")
}

model StudentProfile {
  id                 String  @id @default(cuid())
  userId             String  @unique
  grade              String?
  diagnosticsSummary String?
  problemSubjects    String[]
  requestText        String?
  comment            String?
  iopDocxFileName    String?
  iopDocxBase64      String?
  curatorTeacherId   String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  curatorTeacher TeacherProfile? @relation("StudentCurator", fields: [curatorTeacherId], references: [id], onDelete: SetNull)

  parentLinks ParentStudentLink[]
  teacherLinks TeacherStudentLink[]
}

model ParentProfile {
  id                   String   @id @default(cuid())
  userId               String   @unique
  telegramChatId       String?  @unique
  telegramEnabled      Boolean  @default(false)
  morningReminderHour  Int      @default(8)
  comment              String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  studentLinks ParentStudentLink[]
}

model ParentStudentLink {
  id                        String @id @default(cuid())
  parentId                  String
  studentId                 String
  relationship              String?
  receivesMorningReminder   Boolean @default(true)
  createdAt                 DateTime @default(now())

  parent  ParentProfile  @relation(fields: [parentId], references: [id], onDelete: Cascade)
  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([parentId, studentId])
}

model Event {
  id                 String       @id @default(cuid())
  title              String
  subject            String?
  activityType       ActivityType
  status             EventStatus  @default(PLANNED)
  plannedStartAt     DateTime
  plannedEndAt       DateTime
  factStartAt        DateTime?
  factEndAt          DateTime?
  plannedHours       Int          @default(1)
  billableHours      Int          @default(0)
  isPaid             Boolean      @default(true)
  location           String?
  notes              String?
  cancelReasonId     String?
  cancelComment      String?
  completionComment  String?
  createdByUserId    String
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  createdBy    User            @relation("EventCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  cancelReason CancelReason?   @relation(fields: [cancelReasonId], references: [id], onDelete: SetNull)
  participants EventParticipant[]
  confirmationTasks EventConfirmationTask[]

  @@index([plannedStartAt])
  @@index([status])
  @@index([activityType])
}

model EventParticipant {
  id                String           @id @default(cuid())
  eventId           String
  userId            String
  participantRole   ParticipantRole
  attendanceStatus  AttendanceStatus?
  absenceReason     String?
  attendedMinutes   Int?
  createdAt         DateTime         @default(now())

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId, participantRole])
  @@index([userId, participantRole])
}

model CancelReason {
  id         String  @id @default(cuid())
  code       String  @unique
  name       String
  isActive   Boolean @default(true)
  sortOrder  Int     @default(100)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  events Event[]
}

model TeacherRate {
  id                   String       @id @default(cuid())
  teacherProfileId     String
  activityType         ActivityType
  hourlyRateCents      Int
  effectiveFrom        DateTime
  effectiveTo          DateTime?
  createdAt            DateTime @default(now())

  teacherProfile TeacherProfile @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)

  @@index([teacherProfileId, activityType, effectiveFrom])
}

model TeacherStudentLink {
  id               String   @id @default(cuid())
  teacherProfileId String
  studentProfileId String
  createdAt        DateTime @default(now())

  teacher TeacherProfile @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)
  student StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)

  @@unique([teacherProfileId, studentProfileId])
  @@index([teacherProfileId])
  @@index([studentProfileId])
}

model UserSession {
  id         String   @id @default(cuid())
  userId     String
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model EventConfirmationTask {
  id            String     @id @default(cuid())
  eventId        String
  teacherUserId  String
  status         TaskStatus @default(PENDING)
  createdAt      DateTime   @default(now())
  resolvedAt     DateTime?

  event       Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  teacherUser User  @relation(fields: [teacherUserId], references: [id], onDelete: Cascade)

  @@unique([eventId, teacherUserId])
  @@index([teacherUserId, status])
}
